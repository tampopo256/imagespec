<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”»åƒæ¡ä»¶ä¾¿</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        @media (prefers-color-scheme: dark) {
            .main-card {
                background: rgba(26, 32, 44, 0.95);
                color: #fff;
            }
        }

        .upload-area {
            border: 2px dashed #6c757d;
            border-radius: 10px;
            padding: 3rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #0d6efd;
            background: #e3f2fd;
        }

        @media (prefers-color-scheme: dark) {
            .upload-area {
                background: #343a40;
                border-color: #6c757d;
            }
            .upload-area:hover, .upload-area.dragover {
                background: #495057;
                border-color: #0d6efd;
            }
        }

        .upload-icon {
            font-size: 3rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .crop-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
            max-height: 400px;
            overflow: hidden;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .crop-image {
            max-width: 100%;
            max-height: 400px;
            cursor: crosshair;
        }

        .crop-overlay {
            position: absolute;
            border: 2px solid #0d6efd;
            background: rgba(13, 110, 253, 0.1);
            cursor: move;
            min-width: 50px;
            min-height: 50px;
        }

        .crop-overlay::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 1px dashed #fff;
            margin: 4px;
        }

        .crop-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #0d6efd;
            border: 2px solid #fff;
            border-radius: 50%;
        }

        .crop-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
        .crop-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
        .crop-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .crop-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }

        .condition-banner {
            background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
            color: white;
            border-radius: 10px;
        }

        .share-url {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        @media (prefers-color-scheme: dark) {
            .share-url {
                background: #495057;
                border-color: #6c757d;
                color: #fff;
            }
        }

        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-xl-6">
                <div class="main-card p-4">
                    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                    <div class="text-center mb-4">
                        <h1 class="h2 text-primary fw-bold mb-2">ç”»åƒå¤‰æ›ãƒ„ãƒ¼ãƒ«</h1>
                        <p class="text-muted">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€æ¯”ç‡èª¿æ•´ãƒ»å®¹é‡å‰Šæ¸›ãƒ»å½¢å¼å¤‰æ›ã‚’è¡Œã„ã¾ã™</p>
                    </div>

                    <!-- æ¡ä»¶ãƒãƒŠãƒ¼ -->
                    <div id="conditionBanner" class="condition-banner p-3 mb-4 d-none">
                        <div class="text-center fw-semibold" id="conditionText"></div>
                    </div>

                    <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ -->
                    <div class="upload-area mb-4" id="uploadArea">
                        <div class="upload-icon">ğŸ“¸</div>
                        <div>
                            <p class="h5 mb-2">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>
                            <p class="text-muted">ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                        </div>
                        <input type="file" id="fileInput" class="d-none" accept="image/*" aria-label="ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ">
                    </div>

                    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
                    <div id="previewArea" class="d-none">
                        <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                        <div id="sizeErrorAlert" class="alert alert-warning d-none mb-4" role="alert">
                            <h6 class="alert-heading">âš ï¸ ç”»åƒæ¯”ç‡ãŒè¨­å®šã¨ç•°ãªã‚Šã¾ã™</h6>
                            <p class="mb-3">ç¾åœ¨ã®ç”»åƒæ¯”ç‡ã¨è¨­å®šã•ã‚ŒãŸæ¯”ç‡ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚ä¸‹è¨˜ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ï¼š</p>
                            <div class="d-grid gap-2 d-md-flex">
                                <button id="autoCropBtn" class="btn btn-primary">âœ‚ï¸ è‡ªå‹•ã§åˆ‡ã‚Šå–ã‚Š</button>
                                <button id="manualCropBtn" class="btn btn-outline-primary">ğŸ¯ æ‰‹å‹•ã§åˆ‡ã‚Šå–ã‚Š</button>
                                <button id="ignoreSizeBtn" class="btn btn-outline-secondary">â†’ ãã®ã¾ã¾å‡¦ç†</button>
                            </div>
                        </div>

                        <!-- æ‰‹å‹•åˆ‡ã‚Šå–ã‚Šã‚¨ãƒªã‚¢ -->
                        <div id="cropArea" class="d-none mb-4">
                            <div class="alert alert-info">
                                <p class="mb-2"><strong>æ‰‹å‹•åˆ‡ã‚Šå–ã‚Šãƒ¢ãƒ¼ãƒ‰</strong></p>
                                <p class="mb-0">é’ã„æ ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦åˆ‡ã‚Šå–ã‚Šç¯„å›²ã‚’èª¿æ•´ã—ã€ã€Œåˆ‡ã‚Šå–ã‚Šå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
                            </div>
                            <div class="text-center mb-3">
                                <div id="cropContainer" class="crop-container">
                                    <img id="cropImage" class="crop-image" alt="åˆ‡ã‚Šå–ã‚Šç”¨ç”»åƒ">
                                    <div id="cropOverlay" class="crop-overlay">
                                        <div class="crop-handle nw"></div>
                                        <div class="crop-handle ne"></div>
                                        <div class="crop-handle sw"></div>
                                        <div class="crop-handle se"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                                <button id="executeCropBtn" class="btn btn-success">âœ‚ï¸ åˆ‡ã‚Šå–ã‚Šå®Ÿè¡Œ</button>
                                <button id="cancelCropBtn" class="btn btn-outline-secondary">âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            </div>
                        </div>

                        <div class="text-center mb-4">
                            <img id="previewImage" class="preview-image" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ">
                        </div>
                        
                        <div id="infoPanel" class="alert alert-info mb-4"></div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-center mb-4">
                            <button id="downloadBtn" class="btn btn-primary btn-lg" aria-label="å¤‰æ›ã—ãŸç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                                ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </button>
                            <button id="resetBtn" class="btn btn-success btn-lg" aria-label="ãƒªã‚»ãƒƒãƒˆã—ã¦æ–°ã—ã„ç”»åƒã‚’é¸æŠ">
                                ğŸ”„ ãƒªã‚»ãƒƒãƒˆ
                            </button>
                        </div>
                    </div>

                    <!-- å…±æœ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">å…±æœ‰ãƒªãƒ³ã‚¯</h5>
                            <p class="card-text">ç¾åœ¨ã®è¨­å®šã§ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆã§ãã¾ã™</p>
                            <textarea id="shareUrl" class="form-control share-url mb-3" rows="3" readonly></textarea>
                            <button id="copyBtn" class="btn btn-outline-primary" aria-label="å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼">
                                ğŸ“‹ ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container">
        <div id="toast" class="toast align-items-center text-bg-success border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="toastMessage"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentFile = null;
        let processedCanvas = null;
        let originalImage = null;
        let cropData = null;
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let params = {};
        let toastInstance = null;

        /**
         * URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ãƒ»è§£æ
         */
        function parseUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                ratio: urlParams.get('ratio') || '16:9',
                orient: urlParams.get('orient') || 'landscape',
                maxSize: parseInt(urlParams.get('maxSize')) || 1000,
                format: urlParams.get('format') || 'jpeg',
                maxW: parseInt(urlParams.get('maxW')) || 1920,
                maxH: parseInt(urlParams.get('maxH')) || 1080,
                desc: urlParams.get('desc') || ''
            };
        }

        /**
         * æ¡ä»¶ãƒãƒŠãƒ¼ã‚’è¡¨ç¤º
         * @param {Object} params - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
         */
        function displayConditionBanner(params) {
            if (params.desc) {
                const banner = document.getElementById('conditionBanner');
                const text = document.getElementById('conditionText');
                text.textContent = `å¤‰æ›æ¡ä»¶: ${params.desc}`;
                banner.classList.remove('d-none');
            }
        }

        /**
         * å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
         */
        function generateShareLink() {
            const currentUrl = new URL(window.location);
            currentUrl.search = '';
            
            const urlParams = new URLSearchParams();
            if (params.ratio !== '16:9') urlParams.set('ratio', params.ratio);
            if (params.orient !== 'landscape') urlParams.set('orient', params.orient);
            if (params.maxSize !== 1000) urlParams.set('maxSize', params.maxSize);
            if (params.format !== 'jpeg') urlParams.set('format', params.format);
            if (params.maxW !== 1920) urlParams.set('maxW', params.maxW);
            if (params.maxH !== 1080) urlParams.set('maxH', params.maxH);
            if (params.desc) urlParams.set('desc', params.desc);

            currentUrl.search = urlParams.toString();
            return currentUrl.toString();
        }

        /**
         * ç”»åƒæ¯”ç‡ã‚’ãƒã‚§ãƒƒã‚¯
         * @param {HTMLImageElement} img - ç”»åƒè¦ç´ 
         * @param {Object} params - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
         * @returns {boolean} æ¯”ç‡ãŒä¸€è‡´ã™ã‚‹ã‹ã©ã†ã‹
         */
        function checkImageRatio(img, params) {
            const [ratioW, ratioH] = params.ratio.split(':').map(Number);
            const targetRatio = params.orient === 'portrait' ? ratioH / ratioW : ratioW / ratioH;
            const currentRatio = img.width / img.height;
            
            // 5%ã®èª¤å·®ã‚’è¨±å®¹
            return Math.abs(currentRatio - targetRatio) / targetRatio < 0.05;
        }

        /**
         * æ‰‹å‹•åˆ‡ã‚Šå–ã‚Šæ©Ÿèƒ½ã‚’åˆæœŸåŒ–
         * @param {HTMLImageElement} img - ç”»åƒè¦ç´ 
         */
        function initManualCrop(img) {
            const cropImage = document.getElementById('cropImage');
            const cropOverlay = document.getElementById('cropOverlay');
            const cropContainer = document.getElementById('cropContainer');
            
            // ç”»åƒã‚’ã‚³ãƒ”ãƒ¼
            cropImage.src = img.src;
            cropImage.onload = function() {
                const imgRect = cropImage.getBoundingClientRect();
                const containerRect = cropContainer.getBoundingClientRect();
                
                // åˆæœŸåˆ‡ã‚Šå–ã‚Šç¯„å›²ã‚’è¨­å®šï¼ˆä¸­å¤®1/2ã‚µã‚¤ã‚ºï¼‰
                const [ratioW, ratioH] = params.ratio.split(':').map(Number);
                const targetRatio = params.orient === 'portrait' ? ratioH / ratioW : ratioW / ratioH;
                
                let width, height;
                if (imgRect.width / imgRect.height > targetRatio) {
                    height = imgRect.height * 0.8;
                    width = height * targetRatio;
                } else {
                    width = imgRect.width * 0.8;
                    height = width / targetRatio;
                }
                
                const left = (imgRect.width - width) / 2;
                const top = (imgRect.height - height) / 2;
                
                cropOverlay.style.left = left + 'px';
                cropOverlay.style.top = top + 'px';
                cropOverlay.style.width = width + 'px';
                cropOverlay.style.height = height + 'px';
                
                // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
                setupCropDrag();
            };
        }

        /**
         * åˆ‡ã‚Šå–ã‚Šãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã‚’è¨­å®š
         */
        function setupCropDrag() {
            const cropOverlay = document.getElementById('cropOverlay');
            const cropImage = document.getElementById('cropImage');
            const cropContainer = document.getElementById('cropContainer');
            
            let isResizing = false;
            let resizeDirection = '';
            
            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆç§»å‹•ï¼‰
            cropOverlay.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('crop-handle')) return;
                
                isDragging = true;
                const rect = cropOverlay.getBoundingClientRect();
                const containerRect = cropContainer.getBoundingClientRect();
                dragStart.x = e.clientX - rect.left;
                dragStart.y = e.clientY - rect.top;
                
                e.preventDefault();
            });
            
            // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ã®ãƒ‰ãƒ©ãƒƒã‚°
            const handles = cropOverlay.querySelectorAll('.crop-handle');
            handles.forEach(handle => {
                handle.addEventListener('mousedown', function(e) {
                    isResizing = true;
                    resizeDirection = handle.className.split(' ')[1];
                    
                    const containerRect = cropContainer.getBoundingClientRect();
                    dragStart.x = e.clientX - containerRect.left;
                    dragStart.y = e.clientY - containerRect.top;
                    
                    e.preventDefault();
                    e.stopPropagation();
                });
            });
            
            // ãƒã‚¦ã‚¹ç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆ
            document.addEventListener('mousemove', function(e) {
                const containerRect = cropContainer.getBoundingClientRect();
                const imageRect = cropImage.getBoundingClientRect();
                
                if (isDragging) {
                    // ç§»å‹•å‡¦ç†
                    const newLeft = e.clientX - containerRect.left - dragStart.x;
                    const newTop = e.clientY - containerRect.top - dragStart.y;
                    
                    const maxLeft = imageRect.width - cropOverlay.offsetWidth;
                    const maxTop = imageRect.height - cropOverlay.offsetHeight;
                    
                    cropOverlay.style.left = Math.max(0, Math.min(maxLeft, newLeft)) + 'px';
                    cropOverlay.style.top = Math.max(0, Math.min(maxTop, newTop)) + 'px';
                    
                } else if (isResizing) {
                    // ãƒªã‚µã‚¤ã‚ºå‡¦ç†
                    const currentX = e.clientX - containerRect.left;
                    const currentY = e.clientY - containerRect.top;
                    
                    const [ratioW, ratioH] = params.ratio.split(':').map(Number);
                    const targetRatio = params.orient === 'portrait' ? ratioH / ratioW : ratioW / ratioH;
                    
                    let newWidth = cropOverlay.offsetWidth;
                    let newHeight = cropOverlay.offsetHeight;
                    let newLeft = parseInt(cropOverlay.style.left);
                    let newTop = parseInt(cropOverlay.style.top);
                    
                    if (resizeDirection.includes('e')) {
                        newWidth = currentX - newLeft;
                    }
                    if (resizeDirection.includes('w')) {
                        const oldWidth = newWidth;
                        newWidth = newLeft + newWidth - currentX;
                        newLeft = currentX;
                    }
                    if (resizeDirection.includes('s')) {
                        newHeight = currentY - newTop;
                    }
                    if (resizeDirection.includes('n')) {
                        const oldHeight = newHeight;
                        newHeight = newTop + newHeight - currentY;
                        newTop = currentY;
                    }
                    
                    // æ¯”ç‡ã‚’ç¶­æŒ
                    if (newWidth / newHeight > targetRatio) {
                        newWidth = newHeight * targetRatio;
                    } else {
                        newHeight = newWidth / targetRatio;
                    }
                    
                    // å¢ƒç•Œãƒã‚§ãƒƒã‚¯
                    if (newLeft >= 0 && newTop >= 0 && 
                        newLeft + newWidth <= imageRect.width && 
                        newTop + newHeight <= imageRect.height &&
                        newWidth >= 50 && newHeight >= 50) {
                        
                        cropOverlay.style.left = newLeft + 'px';
                        cropOverlay.style.top = newTop + 'px';
                        cropOverlay.style.width = newWidth + 'px';
                        cropOverlay.style.height = newHeight + 'px';
                    }
                }
            });
            
            // ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
            document.addEventListener('mouseup', function() {
                isDragging = false;
                isResizing = false;
                resizeDirection = '';
            });
        }

        /**
         * æ‰‹å‹•åˆ‡ã‚Šå–ã‚Šã‚’å®Ÿè¡Œ
         */
        function executeCrop() {
            const cropImage = document.getElementById('cropImage');
            const cropOverlay = document.getElementById('cropOverlay');
            
            // åˆ‡ã‚Šå–ã‚Šåº§æ¨™ã‚’è¨ˆç®—
            const imageRect = cropImage.getBoundingClientRect();
            const overlayRect = cropOverlay.getBoundingClientRect();
            
            const scaleX = originalImage.width / imageRect.width;
            const scaleY = originalImage.height / imageRect.height;
            
            cropData = {
                x: parseInt(cropOverlay.style.left) * scaleX,
                y: parseInt(cropOverlay.style.top) * scaleY,
                width: cropOverlay.offsetWidth * scaleX,
                height: cropOverlay.offsetHeight * scaleY
            };
            
            // æ‰‹å‹•åˆ‡ã‚Šå–ã‚Šå®Œäº†å¾Œã®å‡¦ç†
            finalizeCrop();
        }
        /**
         * ç”»åƒã‚’å‡¦ç†ï¼ˆã‚¯ãƒ­ãƒƒãƒ—ãƒ»ãƒªã‚µã‚¤ã‚ºãƒ»å½¢å¼å¤‰æ›ï¼‰
         * @param {File} file - ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«
         * @param {Object} params - å‡¦ç†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
         * @param {boolean} ignoreSizeCheck - ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ã‚’ç„¡è¦–ã™ã‚‹ã‹ã©ã†ã‹
         */
        function processImage(file, params, ignoreSizeCheck = false) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    originalImage = img;
                    
                    // æ¯”ç‡ãƒã‚§ãƒƒã‚¯
                    if (!ignoreSizeCheck && !checkImageRatio(img, params)) {
                        // ã‚µã‚¤ã‚ºã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
                        showSizeError(img);
                        reject(new Error('SIZE_MISMATCH'));
                        return;
                    }
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // æ¯”ç‡è¨ˆç®—
                    const [ratioW, ratioH] = params.ratio.split(':').map(Number);
                    const targetRatio = params.orient === 'portrait' ? ratioH / ratioW : ratioW / ratioH;

                    let { width, height } = img;
                    let sx = 0, sy = 0, sw = width, sh = height;
                    
                    // æ‰‹å‹•åˆ‡ã‚Šå–ã‚Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
                    if (cropData) {
                        sx = cropData.x;
                        sy = cropData.y;
                        sw = cropData.width;
                        sh = cropData.height;
                    } else {
                        // è‡ªå‹•åˆ‡ã‚Šå–ã‚Š
                        const currentRatio = width / height;
                        
                        if (currentRatio > targetRatio) {
                            // å¹…ãŒä½™ã‚‹å ´åˆ
                            sw = height * targetRatio;
                            sx = (width - sw) / 2;
                        } else if (currentRatio < targetRatio) {
                            // é«˜ã•ãŒä½™ã‚‹å ´åˆ
                            sh = width / targetRatio;
                            sy = (height - sh) / 2;
                        }
                    }

                    // å‡ºåŠ›ã‚µã‚¤ã‚ºè¨ˆç®—
                    let outputW = Math.min(params.maxW, sw);
                    let outputH = Math.min(params.maxH, sh);
                    
                    // æ¯”ç‡ã‚’ä¿æŒã—ã¦ãƒªã‚µã‚¤ã‚º
                    if (outputW / outputH > targetRatio) {
                        outputW = outputH * targetRatio;
                    } else {
                        outputH = outputW / targetRatio;
                    }

                    canvas.width = Math.round(outputW);
                    canvas.height = Math.round(outputH);

                    // æç”»
                    ctx.drawImage(img, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);

                    processedCanvas = canvas;
                    resolve(canvas);
                };
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        /**
         * ã‚µã‚¤ã‚ºã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
         * @param {HTMLImageElement} img - ç”»åƒè¦ç´ 
         */
        function showSizeError(img) {
            const errorAlert = document.getElementById('sizeErrorAlert');
            const previewImage = document.getElementById('previewImage');
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’è¡¨ç¤º
            previewImage.src = img.src;
            previewImage.style.border = '3px solid #ffc107';
            
            // ã‚¨ãƒ©ãƒ¼ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º
            errorAlert.classList.remove('d-none');
            
            document.getElementById('previewArea').classList.remove('d-none');
            document.getElementById('uploadArea').classList.add('d-none');
        }

        /**
         * åˆ‡ã‚Šå–ã‚Šå®Œäº†å¾Œã®å‡¦ç†
         */
        async function finalizeCrop() {
            const cropArea = document.getElementById('cropArea');
            const errorAlert = document.getElementById('sizeErrorAlert');
            
            // ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
            cropArea.classList.add('d-none');
            errorAlert.classList.add('d-none');
            
            try {
                // å‡¦ç†ã‚’å®Ÿè¡Œ
                const canvas = await processImage(currentFile, params, true);
                const blob = await adjustFileSize(canvas, params.format, params.maxSize);
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
                const previewImage = document.getElementById('previewImage');
                previewImage.src = URL.createObjectURL(blob);
                previewImage.style.border = 'none';
                
                updateInfoPanel(currentFile, blob, params);
                setupDownloadButton(blob);
                
                showToast('åˆ‡ã‚Šå–ã‚ŠãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                
            } catch (error) {
                showToast('åˆ‡ã‚Šå–ã‚Šå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
                console.error(error);
            }
        }

        /**
         * ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¨­å®š
         * @param {Blob} blob - å‡¦ç†æ¸ˆã¿ç”»åƒã®Blob
         */
        function setupDownloadButton(blob) {
            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.onclick = () => {
                const link = document.createElement('a');
                link.download = `converted_${currentFile.name.split('.')[0]}.${params.format}`;
                link.href = URL.createObjectURL(blob);
                link.click();
            };
        }

        /**
         * ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’èª¿æ•´
         * @param {HTMLCanvasElement} canvas - ã‚­ãƒ£ãƒ³ãƒã‚¹è¦ç´ 
         * @param {string} format - å‡ºåŠ›å½¢å¼
         * @param {number} maxSizeKB - æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºï¼ˆKBï¼‰
         */
        function adjustFileSize(canvas, format, maxSizeKB) {
            return new Promise((resolve) => {
                const mimeType = format === 'png' ? 'image/png' : 'image/jpeg';
                let quality = 0.9;
                
                function tryCompress() {
                    canvas.toBlob((blob) => {
                        const sizeKB = blob.size / 1024;
                        
                        if (sizeKB <= maxSizeKB || quality <= 0.1) {
                            resolve(blob);
                        } else {
                            quality -= 0.1;
                            tryCompress();
                        }
                    }, mimeType, format === 'jpeg' ? quality : undefined);
                }
                
                tryCompress();
            });
        }

        /**
         * æƒ…å ±ãƒ‘ãƒãƒ«ã‚’æ›´æ–°
         * @param {File} originalFile - å…ƒãƒ•ã‚¡ã‚¤ãƒ«
         * @param {Blob} processedBlob - å‡¦ç†å¾Œãƒ•ã‚¡ã‚¤ãƒ«
         * @param {Object} params - å‡¦ç†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
         */
        function updateInfoPanel(originalFile, processedBlob, params) {
            const panel = document.getElementById('infoPanel');
            const originalSizeKB = Math.round(originalFile.size / 1024);
            const processedSizeKB = Math.round(processedBlob.size / 1024);
            const compressionRatio = Math.round((1 - processedBlob.size / originalFile.size) * 100);
            
            panel.innerHTML = `
                <strong>å‡¦ç†çµæœ:</strong><br>
                å…ƒãƒ•ã‚¡ã‚¤ãƒ«: ${originalSizeKB}KB â†’ å¤‰æ›å¾Œ: ${processedSizeKB}KB (-${compressionRatio}%)<br>
                æ¯”ç‡: ${params.ratio} (${params.orient})<br>
                å½¢å¼: ${params.format.toUpperCase()}<br>
                ã‚µã‚¤ã‚ºä¸Šé™: ${params.maxW}Ã—${params.maxH}px, ${params.maxSize}KB
            `;
        }

        /**
         * ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤º
         * @param {string} message - è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
         * @param {string} type - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ— (success, danger)
         */
        function showToast(message, type = 'success') {
            const toastEl = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toastEl.className = `toast align-items-center text-bg-${type} border-0`;
            
            if (toastInstance) {
                toastInstance.dispose();
            }
            toastInstance = new bootstrap.Toast(toastEl);
            toastInstance.show();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            params = parseUrlParams();
            displayConditionBanner(params);
            
            const shareUrl = document.getElementById('shareUrl');
            shareUrl.value = generateShareLink();

            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const previewArea = document.getElementById('previewArea');
            const previewImage = document.getElementById('previewImage');
            const downloadBtn = document.getElementById('downloadBtn');
            const resetBtn = document.getElementById('resetBtn');
            const copyBtn = document.getElementById('copyBtn');

            // ã‚µã‚¤ã‚ºã‚¨ãƒ©ãƒ¼é–¢é€£ã®ãƒœã‚¿ãƒ³
            const autoCropBtn = document.getElementById('autoCropBtn');
            const manualCropBtn = document.getElementById('manualCropBtn');
            const ignoreSizeBtn = document.getElementById('ignoreSizeBtn');
            const executeCropBtn = document.getElementById('executeCropBtn');
            const cancelCropBtn = document.getElementById('cancelCropBtn');

            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
            uploadArea.addEventListener('click', () => fileInput.click());
            
            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });

            /**
             * ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
             * @param {File} file - é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
             */
            async function handleFileSelect(file) {
                if (!file.type.startsWith('image/')) {
                    showToast('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'danger');
                    return;
                }

                currentFile = file;
                cropData = null; // åˆ‡ã‚Šå–ã‚Šãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
                
                try {
                    const canvas = await processImage(file, params);
                    const blob = await adjustFileSize(canvas, params.format, params.maxSize);
                    
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                    const previewImage = document.getElementById('previewImage');
                    previewImage.src = URL.createObjectURL(blob);
                    previewImage.style.border = 'none';
                    
                    document.getElementById('previewArea').classList.remove('d-none');
                    document.getElementById('uploadArea').classList.add('d-none');
                    
                    updateInfoPanel(file, blob, params);
                    setupDownloadButton(blob);
                    
                } catch (error) {
                    if (error.message === 'SIZE_MISMATCH') {
                        // ã‚µã‚¤ã‚ºãƒŸã‚¹ãƒãƒƒãƒã®å ´åˆã¯æ—¢ã«showSizeError()ã§å‡¦ç†æ¸ˆã¿
                        return;
                    }
                    showToast('ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
                    console.error(error);
                }
            }

            // ã‚µã‚¤ã‚ºã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            autoCropBtn.addEventListener('click', async () => {
                try {
                    // è‡ªå‹•åˆ‡ã‚Šå–ã‚Šã§å†å‡¦ç†
                    const canvas = await processImage(currentFile, params, true);
                    const blob = await adjustFileSize(canvas, params.format, params.maxSize);
                    
                    const previewImage = document.getElementById('previewImage');
                    previewImage.src = URL.createObjectURL(blob);
                    previewImage.style.border = 'none';
                    
                    // ã‚¨ãƒ©ãƒ¼ã‚¢ãƒ©ãƒ¼ãƒˆã‚’éè¡¨ç¤º
                    document.getElementById('sizeErrorAlert').classList.add('d-none');
                    
                    updateInfoPanel(currentFile, blob, params);
                    setupDownloadButton(blob);
                    showToast('è‡ªå‹•åˆ‡ã‚Šå–ã‚ŠãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                    
                } catch (error) {
                    showToast('è‡ªå‹•åˆ‡ã‚Šå–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
                }
            });

            manualCropBtn.addEventListener('click', () => {
                // æ‰‹å‹•åˆ‡ã‚Šå–ã‚Šãƒ¢ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
                initManualCrop(originalImage);
                document.getElementById('cropArea').classList.remove('d-none');
            });

            ignoreSizeBtn.addEventListener('click', async () => {
                try {
                    // ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ã‚’ç„¡è¦–ã—ã¦å‡¦ç†
                    const canvas = await processImage(currentFile, params, true);
                    const blob = await adjustFileSize(canvas, params.format, params.maxSize);
                    
                    const previewImage = document.getElementById('previewImage');
                    previewImage.src = URL.createObjectURL(blob);
                    previewImage.style.border = 'none';
                    
                    document.getElementById('sizeErrorAlert').classList.add('d-none');
                    
                    updateInfoPanel(currentFile, blob, params);
                    setupDownloadButton(blob);
                    showToast('å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ');
                    
                } catch (error) {
                    showToast('å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
                }
            });

            executeCropBtn.addEventListener('click', executeCrop);

            cancelCropBtn.addEventListener('click', () => {
                document.getElementById('cropArea').classList.add('d-none');
                cropData = null;
            });
            // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
            resetBtn.addEventListener('click', () => {
                document.getElementById('previewArea').classList.add('d-none');
                document.getElementById('uploadArea').classList.remove('d-none');
                document.getElementById('sizeErrorAlert').classList.add('d-none');
                document.getElementById('cropArea').classList.add('d-none');
                currentFile = null;
                processedCanvas = null;
                originalImage = null;
                cropData = null;
                fileInput.value = '';
            });

            // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
            copyBtn.addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(shareUrl.value);
                    showToast('ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                } catch (error) {
                    showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
                }
            });
        });
    </script>
</body>
</html>